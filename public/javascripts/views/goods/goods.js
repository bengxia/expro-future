var zTree;var zNodes;//保存树节点的json对象var setting = {    async: {        enable: true,        type:"get",        dataType:"text",        contentType:"application/json",        url:"/goods/type",        autoParam:["_id", "name"],        otherParam:{"otherParam":""},//可以传参，暂未使用        dataFilter: filter    },    view: {        dblClickExpand: false,        showLine: true,        selectedMulti: false,        expandSpeed: ($.browser.msie && parseInt($.browser.version)<=6)?"":"fast"    },    data: {        simpleData: {            enable:true,            idKey: "_id",            pIdKey: "parent_id",            rootPId: ""        }    },    callback: {        beforeClick: function beforeClick(treeId, treeNode) {            //var check = (treeNode && !treeNode.isParent);            //if (!check) alert("只能选择叶子节点...");            //return check;            return true;        },        onClick: function onClick(e, treeId, treeNode) {                    zTree = $.fn.zTree.getZTreeObj("tree"),                        nodes = zTree.getSelectedNodes(),                        v = "";                    _id = "";                    if(nodes.length){                        _id = nodes[0]._id;                        v = nodes[0].name;                        $("#type_id").val(_id);                        $("#type_name").val(v);                    }                    hideMenu();                }    }};var filter = function(treeId, parentNode, childNodes) {    if (!childNodes) return null;    for (var i=0, l=childNodes.length; i<l; i++) {        childNodes[i].name = childNodes[i].name.replace(/\.n/g, '.');    }    return childNodes;};var showMenu = function() {    $("#menuContent").slideDown("fast");    $("body").bind("mousedown", onBodyDown);};var hideMenu = function() {    $("#menuContent").fadeOut("fast");    $("body").unbind("mousedown", onBodyDown);};var onBodyDown = function(event) {    if (!(event.target.id == "menuBtn" || event.target.id == "menuContent" || $(event.target).parents("#menuContent").length>0)) {        hideMenu();    }};var showContent = function(){    var _id = $("#_id").val();    if(_id){        $.ajax({            type: "get",            url: '/goods/'+_id,            dataType: "json",            global: false,            async: false,            success: function (data, textStatus) {//                console.log("data:"+JSON.stringify(data));                if(data && data.goods){                    var goods = data.goods;                    $("#name").val(goods.name);                    $("#code").val(goods.code);                    $("#type_id").val(goods.type_id);                    $("#type_name").val(goods.type_name);                    $("#state").val(goods.state);                    $("#price").val(goods.price);                    $("#create_time").val(goods.create_time);                    $("#comment").val(goods.comment);                }else{                    $().message("获取数据失败,返回数据格式错误！");                }            },            error: function () {                $().message("获取信息失败！");            }        });    }};//页面初始化时调用，设置按钮显示，输入框是否只读等属性。var pageInit = function(){    // - 新增(pageState=0)： _id 为空，isReadonly=false, 所有输入框为空，显示：保存按钮    // - 查看(pageState=1)： _id不为空，isReadonly=true， 输入框有数据，显示：关闭按钮    // - 编辑(pageState=2)： _id不为空，isReadonly=false， 输入框有数据，显示：保存按钮 + 关闭按钮    var pageState = $("#pageState").val();    $("#menuContent").hide();    if(0 == pageState){        //新增        $("#save").show();        $("#update").hide();        $("#create_time_div").hide();    }else if(1 == pageState){        //查看        $(".allowInput").attr("readonly","readonly");        $("#save").hide();//启动时隐藏保存按钮        $("#update").hide();        showContent();    }else if(2 == pageState){        //编辑        $("#save").hide();//显示save        $("#update").show();        showContent();    }};var treeInit = function(){    $.ajax({        type: "Get",        url: '/goods/type',        dataType: "text",        global: false,        async: false,        success: function (strReult) {            zNodes=eval(strReult);        },        error: function () {            alert("Ajax请求数据失败!");        }    });    var t = $("#tree");    t = $.fn.zTree.init(t, setting, zNodes);};$(function(){    /*******************************************     *              初始化页面显示     *******************************************/    //页面初始化    pageInit();    treeInit();    /*******************************************     *                    事件响应     *******************************************///    $('#add_form').ajaxForm({//        beforeSubmit: validate,//        success: function(data, status, xhr){//            var jsonStr = JSON.stringify(data);//            console.log('jsonStr:'+jsonStr+" |status:"+status);//            if("success" == status){//                $().message("操作成功！");//                $.fancybox.close();//为防止因为网络延时造成对话框不关闭，再次输入，提前关闭对话框。//                $("#list").trigger("reloadGrid", [{current:true}]);//            }else{//                $().message("添加失败:"+data.error);//            }//        }//    });    //提交表单进行保存    $("#save").click(function(){        var name = $("#name").val();        var code = $("#code").val();        var type_id = $("#type_id").val();        var state = $("#state").val();        var price = $("#price").val();        var comment = $("#comment").val();        var goods_json = {name:name, code:code, type_id:type_id, state:state, price:price,            comment:comment};        console.log("goods_json:"+JSON.stringify(goods_json));        $.ajax({            type: "post",            url: '/goods?_csrf='+$("#_csrf").val(),            dataType: "json",            global: false,            async: false,            data: goods_json,            success: function (data, textStatus) {                $().message("添加成功！");                $("#popDialog").dialog("close");                $("#list").trigger("reloadGrid", [{current:true}]);            },            error: function (XMLHttpRequest, textStatus, errorThrown) {                var res = JSON.parse(XMLHttpRequest.responseText);                $().message(res.error);//有错            }        });    });    //提交表单进行保存    $("#update").click(function(){        var _id = $("#_id").val();        var name = $("#name").val();        var code = $("#code").val();        var type_id = $("#type_id").val();        var state = $("#state").val();        var price = $("#price").val();        var comment = $("#comment").val();        var store_json = {_id:_id, name:name, code:code, type_id:type_id, state:state, price:price,            comment:comment};        console.log("store_json:"+JSON.stringify(store_json));        $.ajax({            type: "put",            url: '/goods?_csrf='+$("#_csrf").val(),            dataType: "json",            global: false,            async: false,            data: store_json,            success: function (data, textStatus) {                $().message("更新成功！");                $("#popDialog").dialog("close");                $("#list").trigger("reloadGrid", [{current:true}]);            },            error: function (XMLHttpRequest, textStatus, errorThrown) {                var res = JSON.parse(XMLHttpRequest.responseText);                $().message(res.error);//有错            }        });    });    function validate(formData, jqForm, options) {    };});