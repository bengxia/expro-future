.fanbox    link(rel='stylesheet', type='text/css', href='/libs/JQuery_zTree_v3.2/css/zTreeStyle/zTreeStyle.css', media='screen')    script(type='text/javascript', src='/libs/JQuery_zTree_v3.2/js/jquery.ztree.core-3.2.js')    style        #testIframe {margin-left: 10px;}    br    br    br#wrapper    .form-container        #menuContent.menuContent(style='display:none; position: absolute;background-color:#CCC')            ul#treeDemo.ztree(style="margin-top:0; ")        form#add_form(action='/goods/#{locals.goods?'?_id='+goods._id:''}', method='#{method}')            p.legend                strong 注意:带                    em *                    |号的为必填字段！            fieldset                legend                div                    input(type='hidden', name='_csrf', value='#{csrf}')                    input#_id(type='hidden', name='_id',value='#{locals.goods?goods._id:''}')                    input#save.btn(type='button', value=' 保 存 ')                    input#close.btn(type='button', value=' 关 闭 ', onclick='$.fancybox.close();')            fieldset#goodsContent                legend(style='color: #C00; font-style: normal;') 商品信息                div                    label.error   商品名称：                    input#name.allowInput(type='text', name='name', value='#{locals.goods?goods.name:''}')                div                    label  资产编号：                    input#code.allowInput(type='text', name='code', value='#{locals.goods?goods.code:''}')                div                    label.error  商品类型：                    input#type_id.allowInput(type='hidden', name='type_id', value='#{locals.goods?goods.type_id:''}')                    input#type_name.allowInput(type='text', name='type_name', value='#{locals.goods?goods.goods_type_name:''}', disabled)                    a#menuBtn(href='#', onclick="showMenu(); return false;")选择商品类型                div                    label.error  状态：                    select#state.allowInput(name='state')                        - var states = [{id:1,value:'上架'},{id:0,value:'下架'}];                        - for (var i in states)                            - var str = "<option value='"+states[i].id+"' >"+states[i].value + " </option>"                            - if(locals.goods && states[i].id == goods.state)                                str = "<option value='"+states[i].id+"' selected='selected'>"+states[i].value + " </option>"                            |!{str}                div                    label.error  售价：                    input#price.allowInput(type='text', name='price', value='#{locals.goods?goods.price:''}')                div#create_time_div                    label  创建时间：                    input#create_time.allowInput(type='text', name='create_time', value='#{locals.goods?goods.create_time:''}', readonly)                div                    label  备注：                    textarea#comment.allowInput(rows='5', cols='40', name='comment') #{locals.goods?goods.comment:''}script(type='text/javascript')    var zTree;    var zNodes;//保存树节点的json对象    var setting = {        async: {            enable: true,            type:"get",            dataType:"text",            contentType:"application/json",            url:"/goods/type",            autoParam:["_id", "name"],            otherParam:{"otherParam":""},//可以传参，暂未使用            dataFilter: filter        },        view: {            dblClickExpand: false,            showLine: true,            selectedMulti: false,            expandSpeed: ($.browser.msie && parseInt($.browser.version)<=6)?"":"fast"        },        data: {            simpleData: {                enable:true,                idKey: "_id",                pIdKey: "parent_id",                rootPId: ""            }        },        callback: {            beforeClick: beforeClick,            onClick: onClick        }    };    function filter(treeId, parentNode, childNodes) {            if (!childNodes) return null;            for (var i=0, l=childNodes.length; i<l; i++) {                childNodes[i].name = childNodes[i].name.replace(/\.n/g, '.');            }            return childNodes;        };    function beforeClick(treeId, treeNode) {        //var check = (treeNode && !treeNode.isParent);        //if (!check) alert("只能选择叶子节点...");        //return check;        return true;    }    function onClick(e, treeId, treeNode) {        zTree = $.fn.zTree.getZTreeObj("treeDemo"),        nodes = zTree.getSelectedNodes(),        v = "";        _id = "";        //nodes.sort(function compare(a,b){return a.id-b.id;});        if(nodes.length){            v = nodes[0].name;            _id = nodes[0]._id;        }        //if (v.length > 0 ) v = v.substring(0, v.length-1);        var type_id = $("#type_id");        var type_name = $("#type_name");        type_id.attr("value", _id);        type_name.attr("value", v);        hideMenu();    }    function showMenu() {        var myObj = $("#type_name");        var myOffset = $("#type_name").offset();        var dialogOffset = $("#fancybox-inner").offset();        var left = myOffset.left - dialogOffset.left;        var top = myOffset.top - dialogOffset.top;        $("#menuContent").css({left:left + "px", top:top + myObj.outerHeight() + "px"}).slideDown("fast");        $("body").bind("mousedown", onBodyDown);    }    function hideMenu() {        $("#menuContent").fadeOut("fast");        $("body").unbind("mousedown", onBodyDown);    }    function onBodyDown(event) {        if (!(event.target.id == "menuBtn" || event.target.id == "menuContent" || $(event.target).parents("#menuContent").length>0)) {            hideMenu();        }    }    $(document).ready(function(){        //页面初始化        pageInit();        $.ajax({            type: "Get",            url: '/goods/type',            dataType: "text",            global: false,            async: false,            success: function (strReult) {                zNodes=eval(strReult);            },            error: function () {                alert("Ajax请求数据失败!");            }        });        var t = $("#treeDemo");        t = $.fn.zTree.init(t, setting, zNodes);    });    $(function(){        $('#add_form').ajaxForm({            beforeSubmit: validate,                success: function(msg){                    if(200 == msg.status || 201 == msg.status){                        $().message(msg.error);                        $.fancybox.close();//为防止因为网络延时造成对话框不关闭，再次输入，提前关闭对话框。                        $("#list").trigger("reloadGrid", [{current:true}]);                    }else{                        $().message("添加失败:"+msg.error);                    }                }        });        //提交表单进行保存        $("#save").click(function(){            $('#add_form').submit();        });        function validate(formData, jqForm, options) {        /*            var name = $("#name").val();            var type_id = $("#type_id").attr("value");            var state = $("#state").attr("value");            var price = $("#price").attr("value");            if(!name || name.trim() == ""){                $().message("<b>请输入'名称'！</b>");                return false;            }else if(!type_id || type_id.trim() == ""){                $().message("<b>请选择'商品类型'！</b>");                return false;            }else if(!state || state.trim() == ""){                $().message("<b>请选择'商品状态'！</b>");                return false;            }else if(!price || price.trim() == ""){                $().message("<b>请输入'商品售价'！</b>");                return false;            }else{                $.fancybox.close();//为防止因为网络延时造成对话框不关闭，再次输入，提前关闭对话框。                $().message("正在提交...");            }        */        };    });    //页面初始化时调用，设置按钮显示，输入框是否只读等属性。    function pageInit(){        // - 新增(pageState=0)： _id 为空，isReadonly=false, 所有输入框为空，显示：保存按钮        // - 查看(pageState=1)： _id不为空，isReadonly=true， 输入框有数据，显示：关闭按钮        // - 编辑(pageState=2)： _id不为空，isReadonly=false， 输入框有数据，显示：保存按钮 + 关闭按钮        if(#{pageState} == 0){            //新增            $("#save").show();            $("#create_time_div").hide();        }else if(#{pageState} == 1){            //查看            $(".allowInput").attr("readonly","readonly");            $("#save").hide();//启动时隐藏保存按钮        }else if(#{pageState} == 2){            //编辑            $("#save").show();//显示save        }    };