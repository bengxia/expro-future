.fanboxbrbr#wrapper    .form-container        form#add_form(action='/member/#{locals.member?'?_id='+member._id:''}', method='#{method}')            p.legend                strong 注意:带                    em *                    |号的为必填字段！                    em 若是新建用户，默认密码为：123456            fieldset                legend                div                    input(type='hidden', name='_csrf', value='#{csrf}')                    input#save.btn(type='button', value=' 保 存 ')                    input#close.btn(type='button', value=' 关 闭 ', onclick='$.fancybox.close();')            fieldset#cellphoneContent                legend 员工手机号码                div                    label  手机号码：                    input#cellphoneFirst.allowInput(type='text', name='cellphoneFirst')                div                    label  请点击‘下一步’：                    input#cellphoneNextBt.btn(type='button', value=' 下一步 ')            //设置密码输入隐藏层            fieldset#passwordContent                legend(style='color: #C00; font-style: normal;') 用户密码验证                div                    label#passwordlabel.error  登陆密码：                    input#passwordCK.allowInput(type='password', name='passwordCK', maxlength='30', value='')                div                    label  请点击‘验证’密码：                    input#checkPasswordBt.btn(type='button', value=' 验证 ')            fieldset#userContent                legend(style='color: #C00; font-style: normal;') 员工信息                div                    label  员工流水号：                    input(type='text', name='_id', value='#{locals.member?member._id:''}',readonly)                div                    label  会员流水号：                    input#user_id.allowUserInput(type='text', name='user_id', value='#{locals.member?member.user_id:''}', readonly)                div#cellphone_div                    label  手机号码：                    input#cellphone.allowInput(type='text', name='cellphone', value='#{locals.user?user.cellphone:''}', readonly)                div                    label.error  昵称：                    input#pet_name.allowInput(type='text', name='pet_name', value='#{locals.member?member.pet_name:''}')                div                    label.error  角色：                    select#role_id.allowInput(name='role_id')                        optgroup(label="请选择一项")                            - for (var i in roles)                                - var str = "<option value='"+roles[i]._id+"' >"+roles[i].name + " </option>"                                - if(locals.member && roles[i]._id == member.role_id)                                    str = "<option value='"+roles[i]._id+"' selected='selected'>"+roles[i].name + " </option>"                                | !{str}                div                    label.error  状态：                    select#state.allowInput(name='state')                        optgroup(label="请选择一项")                            - var states = [{id:1,value:'启用'},{id:0,value:'禁用'},{id:2,value:'脱离'}];                            - for (var i in states)                                - var str = "<option value='"+states[i].id+"' >"+states[i].value + " </option>"                                - if(locals.member && states[i].id == member.state)                                      str = "<option value='"+states[i].id+"' selected='selected'>"+states[i].value + " </option>"                                | !{str}                div                    label  性别：                    select#userSex.allowUserInput(name='sex')                        optgroup(label="请选择一项")                            - var sexStates = [{id:1,value:'男性'},{id:0,value:'女性'}];                            - for (var i in sexStates)                              - var str = "<option value='"+sexStates[i].id+"' >"+sexStates[i].value + " </option>"                              - if(locals.user && sexStates[i].id == user.sex)                                  str = "<option value='"+sexStates[i].id+"' selected='selected'>"+sexStates[i].value + " </option>"                              | !{str}                div                    label  生日：                    input#birthday.allowUserInput(type='text', name='birthday', value='#{locals.user?user.birthday:''}', readonly)                div                    label  创建时间：                    input#create_time.allowInput(type='text', name='create_time', value='#{locals.member?member.create_time:''}', readonly)                div                    label  到期时间：                    input#due_time.allowInput(type='text', name='due_time', value='#{locals.member?member.due_time:''}', readonly)script(type='text/javascript')    $(document).ready(function(){        pageInit();    });    $(function(){        //日期控件        $("#due_time").datepicker({            dateFormat: 'yy-mm-dd',            changeMonth: true,            changeYear: true,            showOn: "button",            buttonImage: "/images/calendar.gif",            buttonImageOnly: true        });        $("#birthday").datepicker({            dateFormat: 'yy-mm-dd',            changeMonth: true,            changeYear: true,            showOn: "button",            buttonImage: "/images/calendar.gif",            buttonImageOnly: true        });        //提交表单参数设定        $('#add_form').ajaxForm({            beforeSubmit: validate,            success: function(result){                if(200 == result.status){                    $().message("成功添加");                    $("#list").trigger("reloadGrid", [{current:true}]);                }else{                    $().message("添加失败:"+result.error);                }            }        });        //提交前校验        function validate(formData, jqForm, options) {            var pet_name = $("#pet_name").attr("value");            var due_time = $("#due_time").attr("value");            if(!pet_name || pet_name.trim() == ""){                $().message("<b>请输入'昵称'！</b>");                return false;            }else if(!due_time || due_time.trim() == ""){                $().message("<b>请输入'到期时间'！</b>");                return false;            }else{                $.fancybox.close();//为防止因为网络延时造成对话框不关闭，再次输入，提前关闭对话框。                $().message("正在提交...");            }        };    });    //提交表单进行保存    $("#save").click(function(){        $('#add_form').submit();    });    //输入手机号码后的“下一步”,显示  1）密码输入； 2）员工信息输入    $("#cellphoneNextBt").click(function(){        var cellphone = $('#cellphoneFirst').attr("value");        if(!cellphone || cellphone.trim() == ""){            return $().message("请您输入手机号码");        }        $("#cellphone").val(cellphone);        $.ajax({            type: "Get",            url: '/memberRegJudge/'+cellphone,            dataType: "json",            global: false,            async: false,            success: function (res) {                //  202-说明user表中无cellphone->创建member and 创建user                //  404-说明user表有cellphone，但member表中没有与user关联的数据->创建member and 关联user_id                //  405-说明user和member中都有数据，->不允许创建。                if(404 == res.status) {                    $().message("手机号码已已存在，请输入登陆密码进行验证！");//有用户                    $("#passwordlabel").html("'"+cellphone+"'密码：");                    $("#passwordContent").slideDown("slow");                    $("#cellphoneContent").hide();                }                else if (202 == res.status) {                    $().message("恭喜，此手机号码允许注册！");//无用户                    $("#userContent").slideDown("slow");                    $("#cellphoneContent").hide();                    //显示保存按钮                    $("#save").slideDown("fast");                }                else if (405 == res.status) {                    $().message("此手机号码已注册，不允许重复注册！");//不允许创建                }                else                    return $().message("有错误产生："+res.error);//有错            },            error: function () {                $().message("Ajax请求数据失败!");            }        });    });    //对输入的密码进行验证    $("#checkPasswordBt").click(function(){        var cellphone = $('#cellphone').attr("value");        var pass = $('#passwordCK').attr("value");        if(!cellphone || cellphone.trim() == ""){            return $().message("请您输入手机号码！");        }        if(!pass || pass.trim() == ""){            return $().message("请您输入密码！");        }        //对用户密码进行验证，如果验证通过，则允许其查看会员信息，并保存员工信息。        checkUser(cellphone, pass);    });    //对用户密码进行验证    function checkUser(cellphone, pass){        $.ajax({            type: "Get",            url: '/user/'+cellphone+'/'+pass,            dataType: "json",            global: false,            async: false,            success: function (res) {                if(200 == res.status) {                    $().message("恭喜，你输入的密码已通过验证！");                    alert(res.user._id);                    //隐藏密码输入框                    $("#passwordContent").fadeOut("slow");                    //显示员工信息                    $("#userContent").slideDown("slow");                    $("#name").val(res.user.name);                    $("#user_id").val(res.user._id);                    $("#userState").val(res.user.state);                    $("#userSex").val(res.user.sex);                    $("#user_pet_name").val(res.user.pet_name);                    $("#birthday").val(res.user.birthday);                    $("#idcard").val(res.user.idcard);                    $("#email").val(res.user.email);                    $("#user_create_time").html(res.user.create_time);                    $("#userComment").val(res.user.comment);                    //将会员信息显示块与员工信息显示块进行对调                    //var memberContent = $("#memberContent").clone();                    //$("#memberContent").remove();                    //$("#userContent").after(memberContent);                    //显示保存按钮                    $("#save").slideDown("fast");                    $("#birthday").datepicker({disabled: true});//日期控件不可选                }                else                    $().message(res.error);            },            error: function () {                alert("Ajax请求数据失败!");            }        });    };    function hideMenu() {        $("#passwordContent").fadeOut("slow");    };    //页面初始化时调用，设置按钮显示，输入框是否只读等属性。    function pageInit(){        // - 新增(pageState=0)： _id 为空，isReadonly=false, 所有输入框为空，显示：保存按钮        // - 查看(pageState=1)： _id不为空，isReadonly=true， 输入框有数据，显示：关闭按钮        // - 编辑(pageState=2)： _id不为空，isReadonly=false， 输入框有数据，显示：保存按钮 + 关闭按钮        if(#{pageState} == 0){            //新增            $("#passwordContent").hide();//启动时隐藏密码输入区域            $("#userContent").hide();//启动时隐藏会员信息            $("#save").show();        }else if(#{pageState} == 1){            //查看            $(".allowInput").attr("readonly","readonly");            $(".allowUserInput").attr("readonly","readonly");            $("#cellphoneContent").hide();            $("#passwordContent").hide();            $("#save").hide();//启动时隐藏保存按钮            $("#due_time").datepicker({disabled: true});//日期控件不可选            $("#birthday").datepicker({disabled: true});//日期控件不可选        }else if(#{pageState} == 2){            //编辑            $("#cellphoneContent").hide();            $("#passwordContent").hide();//启动时隐藏密码输入区域            $("#save").show();//显示save            $("#birthday").datepicker({disabled: true});//日期控件不可选        }        $("#cellphone_div").hide();    };