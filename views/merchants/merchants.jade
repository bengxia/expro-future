!=partial('merchants/sidebar')
//以下是一个jqGrid+fancybox的解决方案
link(rel='stylesheet', type='text/css', href='/libs/jqGrid_fancybox/css/ui-lightness/jquery-ui-1.8.2.custom.css', media='screen')
link(rel='stylesheet', type='text/css', href='/libs/jqGrid_fancybox/css/ui.jqgrid.css', media='screen')
link(rel='stylesheet', type='text/css', href='/libs/jqGrid_fancybox/css/fancybox.css', media='screen')

script(type='text/javascript', src='/libs/jqGrid_fancybox/js/i18n/grid.locale-cn.js')
script(type='text/javascript', src='/libs/jqGrid_fancybox/js/jquery.jqGrid.min.js')
script(type='text/javascript', src='/libs/jqGrid_fancybox/js/jquery.fancybox.js')
script(type='text/javascript', src='/libs/jqGrid_fancybox/js/jquery.form.js')
script(type='text/javascript', src='/libs/jqGrid_fancybox/js/jquery.message.js')
style
 input, textarea, select, .uneditable-input {
     width: auto;
     padding: 0px;
 }
 .input{width:120px; height:19px; line-height:19px; padding:1px; border:1px solid #ccc}
 .btn{width:58px; height:24px; border:1px solid #ccc; background:url(../btn_bg.gif) repeat-x; cursor:pointer;}

 .nodata{display:block; position:absolute; top:100px; left:35%; padding:6px 20px; border:1px solid #fc9; background:#ffc}

 .fanbox{width:540px; padding:0}
 .fanbox h3{height:32px; line-height:32px; padding-left:12px; background:#369; color:#fff}
 .post_table{width:98%; margin:10px auto}
 .post_table td{height:24px; line-height:24px; padding:2px; border:1px solid #ccc; border-collapse:collapse}
 .input2{width:220px; height:20px; line-height:20px; padding:1px; border:1px solid #999}

 .jquery-message{position:absolute;  top:15%; left:45%; background:#217eb9; border:1px solid #ff9; padding:3px 12px 3px 12px; z-index:9001; color:#fff;}

#content
  .panel
    .header
      ul.breadcrumb
        li
          a(href='/') 主页
          span.divider /
        li.active 商户管理
    .inner
      .sep10
      .sep10      
      .grid_table
        #opt
          #query
            label 编号：
            input#sn.input(type='text')
            label 名称：
            input#title.input(type='text')
            input#find_btn.btn(type='submit', value='查 询')
          input#add_btn.btn(type='button', value='新 增')
          input#view_btn.btn(type='button', value='查 看')
          input#edit_btn.btn(type='button', value='修 改')
          input#del_btn.btn(type='button', value='删 除')
        table#list
        #pager
.cl.cr
  script(type='text/javascript')
      jQuery("#list").jqGrid({
        url:'/merchants/index',
        datatype: "json",
        mtype: 'GET',
        gridview:true, //加速显示
        multiselect: true,  //可多选，出现多选框
        multiselectWidth: 25, //设置多选列宽度
        colNames:['商户编号', '简称', '状态','类型','电话','注册时间','到期时间'],
        colModel:[
            {name:'_id',index:'_id', width:100, align:"center",sortable:true},
            {name:'short_name',index:'short_name', width:100, align:"center",sortable:true,
                editable:true,
                edittype:'text',
                editoptions:{size:10,maxlength:15},
                editrules:{required:true},
                formoptions:{elmprefix:':(*)'}
            },
            {name:'state',index:'state', width:80,sortable:true,
                formatter:function(cellvalue, options, row){if(cellvalue==1){return "启用";}else{return "禁用";}},
                align:"center",
                editable:true,
                edittype:'checkbox',
                editoptions:{value:"1:0"},
                editrules:{required:true},
                formoptions:{elmprefix:'是否可用:(*)'}
            },
            {name:'type',index:'type', width:80, align:"center",sortable:true,
                formatter:function(cellvalue, options, row){if(cellvalue==0){return "连锁商户";}else if(cellvalue==1){return "小型商户";}else if(cellvalue==2){return "中型商户";}else if(cellvalue==3){return "大型商户";}},
                align:"center",
                editable:true,
                edittype:'text',
                editoptions:{size:10,maxlength:15},
                editrules:{required:true},
                formoptions:{elmprefix:':(*)'}
            },
            {name:'phone',index:'phone', width:90, align:"center",sortable:true,
                editable:true,
                edittype:'text',
                editoptions:{size:10,maxlength:15},
                editrules:{required:true},
                formoptions:{elmprefix:':(*)'}
            },
            {name:'create_time',index:'create_time', width:100, align:"center",sortable:true,
                editable:true,
                edittype:'text',
                editoptions:{size:10,maxlength:15},
                editrules:{required:true},
                formoptions:{elmprefix:':(*)'}
            },
            {name:'due_time',index:'due_time', width:100, align:"center",sortable:true,
                editable:true,
                edittype:'text',
                editoptions:{size:10,maxlength:15},
                editrules:{required:true},
                formoptions:{elmprefix:':(*)'}
            }
        ],
        rowNum:10,
        rowList:[10,20,30],
        pager: '#pager',
        sortname: 'create_time',
        sortorder:'desc',
        viewrecords: true,      
        caption:"商户列表",
        autowidth: true, //自动匹配宽度
        editurl:"/merchants/",
        height: 500,
        loadComplete:function(data){ //完成服务器请求后，回调函数
          if(data.records == undefined){ //如果没有记录返回，追加提示信息，删除按钮不可用
              $("p").appendTo($("#list")).addClass("nodata").html('找不到相关数据！');
              $("#del_btn").attr("disabled",true);
          }else{ //否则，删除提示，删除按钮可用
              $("p.nodata").remove();
              $("#del_btn").removeAttr("disabled");
          }
        },
         loadError:function(xhr,status,error){
             $("p").appendTo($("#list")).addClass("nodata").html('找不到相关数据！');
             $("#del_btn").attr("disabled",true);
         }
      });
      $(function(){
        $("#add_btn").click(function(){
            $.fancybox({
                'title':'新增商户',
                'autoDimensions':false,
                'type':'ajax',
                'href':'/merchants',
                'width': 700,
                'height': 800,
                'modal':true,
                'titleShow':true,
                'titlePosition':'over',
                'showCloseButton':true,
                'showNavArrows':false,
                'transitionIn': 'elastic',//（效果出入）属性值有三个：fade,elastic,none,含义分别为淡入淡出、弹性缩放、无，默认值为fade。
                'transitionOut': 'elastic',
                'centerOnScroll':false,
                'onComplete': function() {$("#fancybox-title").css({'top':'0px', 'bottom':'auto'});}
            });
        });
        $("#view_btn").click(function(){
            var sels = $("#list").jqGrid('getGridParam','selarrrow');
                if(sels==""){
                    $().message("请选择要查看的项！");
                }else{
                    if(sels.toString().indexOf(',') > 0){
                        $().message("只可选择一项进行查看！");
                    }else{
                        $.fancybox({
                            'title':'查看门店信息',
                             'titleFormat': function(title, currentArray, currentIndex, currentOpts) {
                                                var str = '<span id="fancybox-title-over">'
                                                    + (currentIndex + 1) + ' / '
                                                    + currentArray.length
                                                    + (title.length ? '   ' + title : '')
                                                    + '</span>';
                                                return str;
                                                },
                            'autoDimensions':false,
                            'type':'ajax',
                            'href':'/merchants/'+sels+"/false",
                            'width': 500,
                            'height': 800,
                            'modal':true,
                            'titleShow':true,
                            'titlePosition':'over',
                            'cyclic': true,
                            'showCloseButton':true,
                            'showNavArrows':false,
                            'transitionIn': 'elastic',//（效果出入）属性值有三个：fade,elastic,none,含义分别为淡入淡出、弹性缩放、无，默认值为fade。
                            'transitionOut': 'elastic',
                            'centerOnScroll':false,
                            'onComplete': function(data) {
                                $("#fancybox-title").css({'top':'0px', 'bottom':'auto'});
                            }
                        });
                    }
                }
        });
        $("#edit_btn").click(function(){
            var sels = $("#list").jqGrid('getGridParam','selarrrow');
            if(sels==""){
                $().message("请选择要编辑的项！");
            }else{
                if(sels.toString().indexOf(',') > 0){
                    $().message("只可选择一项进行编辑！");
                }else{
                    $.fancybox({
                        'title':'修改门店信息',
                         'titleFormat': function(title, currentArray, currentIndex, currentOpts) {
                                            var str = '<span id="fancybox-title-over">'
                                                + (currentIndex + 1)
                                                + ' / ' + currentArray.length
                                                + (title.length ? '   ' + title : '')
                                                + '</span>';
                                            return str;
                                            },
                        'autoDimensions':false,
                        'type':'ajax',
                        'href':'/merchants/'+sels+"/true",
                        'width': 500,
                        'height': 800,
                        'modal':true,
                        'titleShow':true,
                        'titlePosition':'over',
                         'cyclic': true,
                        'showCloseButton':true,
                        'showNavArrows':false,
                        'transitionIn': 'elastic',//（效果出入）属性值有三个：fade,elastic,none,含义分别为淡入淡出、弹性缩放、无，默认值为fade。
                        'transitionOut': 'elastic',
                        'centerOnScroll':false,
                        'onComplete': function() {$("#fancybox-title").css({'top':'0px', 'bottom':'auto'});}
                    });
                }
            }
        });        
        $("#del_btn").click(function(){
            var sels = $("#list").jqGrid('getGridParam','selarrrow');
            if(sels==""){
                alert('请选择要删除的项！')
            }else{
                if(confirm("您是否确认删除？")){
                    $.ajax({
                        type: "delete",
                        url: "/merchants/"+sels,
                        //data: "_csrf=#{csrf}",
                        beforeSend: function() {
                            $().message("正在请求...");
                        },
                        error:function(){
                            $().message("请求失败...");
                        },
                        success: function(msg){
                            if(msg._ids){
                                var arr = msg._ids.split(',');
                                $.each(arr,function(i,n){
                                    if(arr[i]!=""){
                                        $("#list").jqGrid('delRowData',n);
                                    }
                                });
                                $().message("已成功删除!");
                            }else{
                                $().message("操作失败！");
                            }
                        }
                    });
                }
            }
        });
       });




      /*
      jQuery("#list").jqGrid('navGrid','#pager',{add:true,del:true,edit:true},{},{},{},{multipleSearch:true, multipleGroup:true, showQuery: true});
      */
        /*
      jQuery("#navgrid").jqGrid('navGrid','#pager',{height:280,reloadAfterSubmit:false}, //options
        {height:280,reloadAfterSubmit:false}, // edit options
        {height:500,afterSubmit:function(response, postdata){alert('111')}, closeAfterAdd: true, closeAfterEdit: true
        }, // add options
        {reloadAfterSubmit:false}, // del options
        {} // search options
      );
      */
      //$("#bedata").click(function(){
      //  jQuery("#list").jqGrid('editGridRow',"new",{height:280,reloadAfterSubmit:false});
      //});

